# Use configurable base image
ARG BASE_IMAGE=buglord/cursord
ARG BASE_TAG=latest
FROM ${BASE_IMAGE}:${BASE_TAG}

# Install windsurf
RUN wget -O /tmp/windsurf.tar.gz https://windsurf-stable.codeiumdata.com/linux-x64/stable/b3241b91445f79878ccc91626dfe190f90563e53/Windsurf-linux-x64-1.5.9.tar.gz && \
    tar -xzvf /tmp/windsurf.tar.gz && \
    mv Windsurf /usr/local/windsurf && \
    chown -R coder:coder /usr/local/windsurf && \
    rm /tmp/windsurf.tar.gz

# Copy windsurf startup script
COPY windsurf-ubuntu.sh /bin/windsurf.sh
RUN chmod +x /bin/windsurf.sh && \
    chown coder:coder /bin/windsurf.sh

# Create windsurf desktop entry
RUN mkdir -p /home/coder/Desktop && \
    echo "[Desktop Entry]" > /home/coder/Desktop/windsurf.desktop && \
    echo "Name=Windsurf" >> /home/coder/Desktop/windsurf.desktop && \
    echo "Exec=/bin/windsurf.sh" >> /home/coder/Desktop/windsurf.desktop && \
    echo "Icon=/usr/local/windsurf/resources/app/resources/linux/code.png" >> /home/coder/Desktop/windsurf.desktop && \
    echo "Type=Application" >> /home/coder/Desktop/windsurf.desktop && \
    echo "Categories=Development;" >> /home/coder/Desktop/windsurf.desktop && \
    chmod +x /home/coder/Desktop/windsurf.desktop && \
    chown -R coder:coder /home/coder/Desktop

# Copy Chrome extension setup script
COPY setup-chrome-extensions.sh /tmp/setup-chrome-extensions.sh

# Install Chrome extensions for the default user
RUN chmod +x /tmp/setup-chrome-extensions.sh && \
    /tmp/setup-chrome-extensions.sh && \
    rm /tmp/setup-chrome-extensions.sh

# Expose XRDP port
EXPOSE 3389

# Set entrypoint to supervisord
ENTRYPOINT ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
