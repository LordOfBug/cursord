# Use configurable base image
ARG BASE_IMAGE=buglord/cursord
ARG BASE_TAG=latest
FROM ${BASE_IMAGE}:${BASE_TAG}

# Define ARG for Windsurf version (for tagging purposes)
ARG WINDSURF_VERSION

# Install windsurf using apt repository
RUN apt-get update && apt-get install -y curl gnupg && \
    curl -fsSL "https://windsurf-stable.codeiumdata.com/wVxQEIWkwPUEAGf3/windsurf.gpg" | gpg --dearmor -o /usr/share/keyrings/windsurf-stable-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/windsurf-stable-archive-keyring.gpg arch=amd64] https://windsurf-stable.codeiumdata.com/wVxQEIWkwPUEAGf3/apt stable main" | tee /etc/apt/sources.list.d/windsurf.list > /dev/null && \
    apt-get update && \
    apt-get install -y windsurf && \
    echo "Installed Windsurf version: ${WINDSURF_VERSION}" && \
    mkdir -p /usr/local/windsurf && \
    ln -sf /usr/bin/windsurf /usr/local/windsurf/ && \
    chown -R coder:coder /usr/local/windsurf

# Copy Chrome extension setup script
COPY setup-chrome-extensions.sh /tmp/setup-chrome-extensions.sh

# Install Chrome extensions for the default user
RUN chmod +x /tmp/setup-chrome-extensions.sh && \
    /tmp/setup-chrome-extensions.sh && \
    rm /tmp/setup-chrome-extensions.sh

# Expose XRDP port
EXPOSE 3389

# Set entrypoint to supervisord
ENTRYPOINT ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
